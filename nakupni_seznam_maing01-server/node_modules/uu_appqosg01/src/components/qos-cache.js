const { Config, OptsReader, LruCache } = require("uu_appg01_core-utils");
const APP_QOS_QUOTA_CACHE_TTL_CONFIG_NAME = "uu_app_qos_quota_cache_ttl";
const DEFAULT_APP_QOS_QUOTA_CACHE_TTL = 60 * 5;
const APP_QOS_QUOTA_CACHE_NAME = "uu_app_qos_quota";

class QosCache {
  constructor() {
    this.opts = new OptsReader(Config);
    this.cacheTtl = this.opts.get(APP_QOS_QUOTA_CACHE_TTL_CONFIG_NAME, DEFAULT_APP_QOS_QUOTA_CACHE_TTL);
    this.maxAge = this.getCacheTtl() * 1000;
    this.rateLimitCache = new LruCache({ maxSize: 2, maxAge: this.maxAge });
  }

  saveQuota(quota, maxAge = this.maxAge) {
    this.rateLimitCache.set(APP_QOS_QUOTA_CACHE_NAME, quota, maxAge);
  }

  getQuota() {
    return this.rateLimitCache.get(APP_QOS_QUOTA_CACHE_NAME);
  }

  getCacheTtl() {
    return this.cacheTtl;
  }

  setMaxAge(cacheTtl = this.cacheTtl) {
    this.maxAge = cacheTtl * 1000;
  }
}

module.exports = new QosCache();
